- name: enable camera
  command: raspi-config nonint do_camera 0
  become: true
  become_user: root

- name: mkdir root/liveStreaming
  file:
    path: /home/pi/node_programs/root/liveStreaming
    state: directory
    mode: 0755

- name: mkdir root/liveStreaming/stream
  file:
    path: /home/pi/node_programs/root/liveStreaming/stream
    state: directory
    mode: 0755

- name: New node project
  copy:
    src: ../files/package.json
    dest: /home/pi/node_programs/root/liveStreaming/package.json
    mode: 0755

- name: install express socket.io --save
  command: npm install express socket.io --save
  args:
    chdir: /home/pi/node_programs/root/liveStreaming/
    creates: /home/pi/node_programs/liveStreaming/node_modules

- name: Copy index.js
  copy:
    src: ../files/index.js
    dest: /home/pi/node_programs/root/liveStreaming/index.js
    mode: 0755

- name: Copy index.html
  copy:
    src: ../files/index.html
    dest: /home/pi/node_programs/root/liveStreaming/index.html
    mode: 0755

- name: Check if port 8080 is listening
  wait_for:
    port: 8080
    delay: 5
    timeout: 10
    msg: "Timeout waiting for 8080 to respond"
  register: port_check
  ignore_errors: yes

- name: start Node
  shell: nodejs index.js
  args:
    chdir: /home/pi/node_programs/root/liveStreaming
  async: 1000
  poll: 0
  when: port_check.failed == true
  become: true
  become_user: root
