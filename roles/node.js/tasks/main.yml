- name: Update apt-get cache
  apt: >
    update_cache=yes
  become: true
  become_user: root

- name: install packages
  apt: 
    name="{{item}}" 
    update_cache=yes 
    state=latest
  with_items:
  - nodejs 
  - npm 
  - node-semver
  become: true
  become_user: root

- name: mkdir node_programs
  file:
    path: /home/pi/node_programs
    state: directory
    mode: 0755

- name: mkdir node_programs/root
  file:
    path: /home/pi/node_programs/root
    state: directory
    mode: 0755

- name: New node project
  copy:
    src: ../files/package.json
    dest: /home/pi/node_programs/package.json
    mode: 0755

- name: Copy app.js
  copy:
    src: ../files/app.js
    dest: /home/pi/node_programs/app.js
    mode: 0755

- name: Copy manager.js
  copy:
    src: ../files/manager.js
    dest: /home/pi/node_programs/root/manager.js
    mode: 0755

- name: install npm manager --save
  command: npm install manager pm2 -g --save
  args:
    chdir: /home/pi/node_programs
    creates: /home/pi/node_programs/node_modules
  become: true
  become_user: root

- name: Check if port 3000 is listening
  wait_for:
    port: 3000
    delay: 5
    timeout: 10
    msg: "Timeout waiting for 3000 to respond"
  register: port_check
  ignore_errors: yes

- name: start Node
  shell: nodejs app.js
  args:
    chdir: /home/pi/node_programs/
  async: 1000
  poll: 0
  when: port_check.failed == true

